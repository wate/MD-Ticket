AIエージェント向けガイド
=========================

このドキュメントは、AIエージェントがMD-Ticketを効果的に利用するためのガイドラインです。

前提条件
-------------------------

### AGENTS.md統合の必須性

このドキュメント(`.ticket/AGENTS.md`)を機能させるには、プロジェクトルートの`AGENTS.md`への統合が必要です。統合方法は[README.md](README.md)の「AGENTS.md統合ガイド」を参照してください。

**統合しない場合のリスク**:

- AIがMD-Ticketの存在を認識できない
- チケットが誤った場所に作成される
- テンプレート構造や命名規則が守られない

### バージョン管理について

Git管理は任意です。エージェントはGit管理の有無を意識する必要はありません。

基本原則
-------------------------

1. **明確性の優先**: 不明点はユーザーに確認する(推測で補わない)
2. **テンプレート遵守**: 各チケット種別のテンプレートを使用する
3. **段階的詳細化**: アイデア→要望→タスクの流れを尊重する
4. **ライフサイクル管理**: チケットの状態に応じてファイルを移動・削除する
5. **関連性の記録**: チケット間の関連を明確にする

チケットスコープ外の修正時の確認プロセス
-------------------------

チケットの主目的から外れる修正や影響範囲が大きい修正は、実施前に必ずユーザーに確認してください。

### 確認が必要な条件

- 変更ファイル数が3つ以上
- 既存機能の動作変更を伴う
- テストが複数のコマンドにまたがる
- チケットの主目的から外れる修正

### ユーザーへの確認方法

範囲外と判断した場合、以下を提示して承認を得る。

- 本チケットの主目的と指示内容の関係
- 範囲外である理由と影響範囲
- 推奨アクション(別チケット化/今すぐ実施/見送り)

### 段階的な実施

複数の修正は1つずつ提案・実施・テストし、デグレ発生時に該当変更を特定可能にする。

設定ファイル
-------------------------

チケット種別は`.ticket/config.yml`で管理されます(任意)。

### 設定ファイルがある場合

種別情報(label、template、description)を参照してチケット作成を行います。

```yaml
types:
  bug:
    label: バグ報告
    template: bug.md
    description: 不具合の報告
  task:
    label: タスク
    template: task.md
    description: 実行すべき作業
  # カスタム種別も定義可能
```

### 設定ファイルがない場合

デフォルトの4種別を使用します。

- `bug`: バグ報告
- `task`: タスク
- `idea`: アイデア
- `request`: 要望

### チケット作成フロー

1. `.ticket/config.yml`の存在確認
2. 存在する場合は設定ファイルから種別情報取得、存在しない場合はデフォルト4種別使用
3. ユーザーの依頼内容から適切な種別判断
4. 対応するテンプレートを使用してチケット作成

チケット種別の判断
-------------------------

### アイデア(`idea/`)

発想・構想段階のメモ。実現可能性が未検証。

**該当条件**:

- 具体的な実装方法が未定
- 「こんなことができたら」という仮説段階
- 技術的実現可能性が未検証

**迷うケース**: 「考えているんだけど」「思いついた」→ アイデア

### 要望(`request/`)

実現してほしい希望。背景と期待する結果が明確。

**該当条件**:

- 「こうなってほしい」が明確
- 具体的な作業には至らないが方向性は定まっている
- 他者への依頼・提案を前提とした内容

**迷うケース**: 「できたらいいな」と「やってほしい」の中間 → ユーザーに「すぐに着手する予定か」を確認

### タスク(`task/`)

実行すべき作業。前提条件と具体的な内容が定まっている。

**該当条件**:

- 実行すべき具体的な作業内容が明確
- 前提条件や必要リソースが特定できている
- 完了条件・成果物が定義可能

**迷うケース**: アイデア・要望から派生した実行可能な作業 → 元チケットへの参照を含めてタスク化

### バグ(`bug/`)

不具合の報告。再現手順と期待/実際の動作が記載可能。

**該当条件**:

- 既存システム・プロセスの不具合
- 期待される動作と実際の動作に乖離
- 再現可能な問題

**迷うケース**: 仕様が不明確 → ユーザーに仕様確認

チケット作成
-------------------------

### 1. 種別判断

ユーザーの依頼内容から適切なチケット種別を判断します。

**判断プロセス**:

1. 「チケット種別の判断」セクションの該当条件を参照
2. 迷うケースに該当する場合はユーザーに確認
3. 複数種別に該当する可能性がある場合は、選択肢を提示してユーザーに選択を求める

判断した種別をユーザーに伝え、承認を得てから次のステップに進みます。

### 2. 情報収集

チケット作成に必要な情報を収集します。

#### 共通必須項目

- チケット種別(ステップ1で決定済み)
- 背景・理由(なぜこのチケットが必要か)

#### 種別固有の必須項目

**アイデア**:

- きっかけ(どのような状況で思いついたか)
- 概要(アイデアの内容)

**要望**:

- 概要(何を実現したいか)
- 背景・理由(なぜ必要か、期待される効果)

**タスク**:

- 前提条件(実行に必要な環境・リソース)
- 依頼/作業内容(具体的に何をするか)
- 背景・理由(なぜこの作業が必要か)

**バグ**:

- 不具合概要(何が問題か)
- 再現手順(どのような操作で発生するか)
- 期待される動作(本来どうあるべきか)
- 実際の動作(現状どうなっているか)

**情報が不足している場合**:

不足している項目を具体的に列挙し、ユーザーに追加情報を求めます。
例: 「タスク作成には以下の情報が必要です: 前提条件、作業内容の詳細」

### 3. ファイル名決定

チケット内容を簡潔に表すファイル名を決定します。

**命名規則**: `brief-description.md`

- 小文字のみ使用
- 単語はハイフン(-)で区切る
- 3-5単語程度(最大60文字)
- 動詞を含める(add, fix, update, remove等)

**命名例**:

- `add-user-authentication.md`: ユーザー認証機能追加
- `fix-login-bug.md`: ログインバグ修正
- `update-database-schema.md`: データベーススキーマ更新
- `improve-api-performance.md`: API性能改善

決定したファイル名をユーザーに提示し、必要に応じて調整します。

### 4. テンプレート取得と作成

適切なテンプレートを使用してチケットファイルを作成します。

#### テンプレート取得

`.ticket/_template/{type}.md`から該当するテンプレートを取得します。
テンプレートが存在しない場合は、基本構造で作成します。

#### 項目記入

1. 必須項目を収集した情報で埋める
2. オプション項目は情報がある場合のみ記入
3. 情報がないオプション項目は削除

#### 保存とディレクトリ確認

```bash
# 種別ディレクトリの存在確認
if [ ! -d ".ticket/{type}" ]; then
  mkdir -p .ticket/{type}
fi

# チケットファイル作成
# .ticket/{type}/{filename}.md に保存
```

### 5. 作成完了の報告

チケット作成完了をユーザーに報告します。

**報告内容**:

- 作成したチケットのパス
- チケット種別
- ファイル名

**報告例**:

「タスクチケットを作成しました: `.ticket/task/add-user-authentication.md`」

参考資料が必要な場合は、配置場所と命名規則を案内します。

チケット管理
-------------------------

### 更新

追加情報、進捗記録、関連チケット作成時にチケット更新を提案します。
大幅な変更の場合はユーザー確認を求めます。

### 種別変更(ファイル移動)

チケットの成熟度に応じて種別変更が必要な場合があります。

- アイデア → 要望: やりたいことが明確化
- アイデア/要望 → タスク: 実行可能な作業に落とし込めた
- タスク → バグ: 実装後に不具合として扱うべきと判明

**手順**:

1. ユーザーに種別変更を確認
2. ファイルを適切なディレクトリに移動(例: `mv request/add-feature.md task/add-feature.md`)
3. 必要に応じてテンプレート項目を更新
4. 他チケットから参照されている場合はパス更新

**注意**: ファイル名は変更しない(ディレクトリのみ変更)

チケットクローズ
-------------------------

**重要**: チケット完了時は必ず以下の手順を実施してください。

### 1. クローズ確認(必須)

以下の状況でチケットクローズを提案します。

- タスク完了報告を受けた場合
- バグ修正完了の報告があった場合
- アイデア・要望が実現不要と判断された場合
- ユーザーから「終わった」「やらない」等の発言があった場合

ユーザーに「このチケットをクローズしますか?」と明示的に確認します。

### 2. 記録状況の確認(必須)

クローズ前に以下を確認し、不足があれば記録を促します。

**完了の場合**:

- 実施内容・成果物の記録
- 完了条件の充足確認
- 重要な技術判断がある場合はADR作成を提案

**取りやめの場合**:

- 取りやめ理由の記録
- 今後の参考となる判断経緯があればADR作成を提案

### 3. ファイル処理(必須)

#### 参考資料の確認

チケット関連の参考資料(`_files/`内)の有無を確認します。

**参考資料が存在する場合**:

1. 資料の一覧をユーザーに提示
2. 各ファイルの処理方法を確認: 「削除(推奨)/アーカイブ/保持」

**判断基準**:

- 削除: 一時的なドラフト、作業中のスクリーンショット等
- アーカイブ: 将来参照する可能性がある設計資料等
- 保持: 他チケットからも参照される共有資料

#### 関連チケットの確認

他チケットからこのチケットへの参照がないか確認します。

**確認方法**: `.ticket/`配下の全Markdownファイルを検索(grep等)

**参照が見つかった場合**:

1. 参照元チケットの一覧をユーザーに提示
2. 各参照の処理方針を確認
    - リンクを削除(チケット完了により参照不要)
    - リンクを残す(履歴として保持)
    - アーカイブ後のパスに更新(参照を継続)

### 4. 処理の実行(必須)

ユーザーの選択に応じて処理を実行します。

**削除を選択した場合**:

```bash
# チケットファイル削除
rm .ticket/{type}/{ticket-name}.md

# 参考資料削除(削除を選択した資料のみ)
rm .ticket/_files/{ticket-name}-*.{ext}
```

**アーカイブを選択した場合**:

「アーカイブ」セクションの手順に従います。

### 5. ADR記録の提案(推奨)

重要な判断を含むチケットの場合、クローズ前にADR記録を提案します。

**ADR記録を推奨するケース**:

- 技術選定・アーキテクチャ判断を含む
- 複数の選択肢から選定した
- 将来の意思決定に影響する
- 同様の課題が再発する可能性がある

### アーカイブ

判断経緯を残したいチケットは以下の手順でアーカイブします。

1. `_archive/YYYY-MM/`ディレクトリを作成
2. チケットファイルを移動し、種別プレフィックスを付与(例: `task-completed.md`)
3. 参考資料があれば`_archive/_files/`に移動
4. 他チケットから参照されている場合はパスを更新

### 関連付け

関連チケットは種別(関連/前提/派生/重複)とリンクで記述します。
重要な関連情報はリンクだけでなく、チケット内に概要も記載します。

参考資料管理
-------------------------

### 配置と命名

チケット関連の参考資料は`_files/`ディレクトリで管理します。

**配置場所**: `.ticket/_files/`

**命名規則**: `{ticket-name}-{suffix}.{ext}`

- `{ticket-name}`: チケットファイル名(拡張子なし)
- `{suffix}`: ファイルの役割を示す識別子(draft, screenshot, diagram等)
- `{ext}`: ファイル拡張子

**例**:

- `add-feature-draft.md`: チケット`add-feature.md`のドラフト
- `fix-login-bug-screenshot.png`: チケット`fix-login-bug.md`のスクリーンショット
- `database-design-diagram.png`: チケット`database-design.md`の図表

### 管理対象ファイル

以下のような参考資料を配置します。

- ドラフト文書(検討段階のテキスト)
- スクリーンショット(UI、エラー画面等)
- 図表・ダイアグラム(システム構成図、フロー図等)
- サンプルコード(検討中のコード断片)
- 設計メモ(手書きスキャン、ホワイトボード写真等)

**注意**: 機密情報(パスワード、APIキー、個人情報等)を含むファイルは配置しない

### チケットクローズ時の処理

チケット完了・取りやめ時に、参考資料の処理方法をユーザーに確認します。

**削除(推奨)**: 作業完了後に不要になった一時的な資料

- 検討途中のドラフト
- 作業中のスクリーンショット
- デバッグ用の一時ファイル

**アーカイブ**: 将来参照する可能性がある資料

- 重要な設計判断の根拠となる図表
- 問題解決プロセスを示すスクリーンショット
- 再利用可能な設計パターン

**保持**: 他チケットからも参照される共有資料

- 複数チケットで使用する共通図表
- プロジェクト全体で参照するリファレンス

アーカイブする場合は、チケットと一緒に`_archive/_files/`に移動します。

### 定期的な整理

以下のタイミングで参考資料の整理を提案します。

- クローズされたチケットの参考資料が残っている場合
- `_files/`に多数のファイルが蓄積されている場合
- 命名規則に従わないファイルが存在する場合

確認が必要なケース
-------------------------

以下の場合は必ずユーザーに確認を求めます。

- 情報不足: 必須項目の情報、種別判断の根拠、背景・理由が不明
- 判断の曖昧性: 複数種別への該当可能性、優先度・緊急度不明、重複の可能性
- 重要な決定: 大幅な変更、種別変更、削除、複数タスクへの分割
- 技術的・業務的判断: セキュリティ・パフォーマンス影響、他システム・チームへの影響、実現可能性判断

ベストプラクティス
-------------------------

### 作成時の注意点

1. **一つのチケットに一つのトピック**: 複数の異なる内容を詰め込まない
2. **具体的な記述**: 「あれ」「それ」などの代名詞を避け、具体的に記述
3. **背景の明確化**: なぜこのチケットが必要なのかを必ず記載
4. **完了条件の明示**: 特にタスクでは、何をもって完了とするかを明確に

### コミュニケーション

1. **確認のタイミング**: 情報不足を感じたら即座に確認
2. **選択肢の提示**: 判断が必要な場合は2-3の選択肢を提示
3. **リスクの共有**: 潜在的な問題や制約があれば事前に伝える
4. **代替案の提案**: より良い方法がありそうな場合は提案

### 継続的改善

1. **パターンの学習**: ユーザーの好みや傾向を学習し、提案の質を向上
2. **一貫性の維持**: 同様のケースでは同様の判断基準を適用
3. **フィードバックの活用**: ユーザーの修正や指摘を次回に活かす

ADRと共有リソース
-------------------------

### ADRの作成と管理

重要な技術判断(技術スタック選定、アーキテクチャ採用、設計決定等)はADR(Architecture Decision Record)として`.ticket/_shared/adr/`に記録します。
複数選択肢がある場合や将来的に参照が必要な判断で作成を提案します。

**命名規則**: `brief-description-YYYYMMDD.md`(例: `database-selection-20230115.md`)

### `_shared/`と`docs/`の使い分け

- `_shared/`: ADR、チケット作業中の補足情報、開発プロセス情報
- `docs/`: 正式な設計書、API仕様書、マニュアル、システム構成図、運用手順書

よくある対応パターン
-------------------------

- 種別判断が難しい → 「実現したい」意思の明確さで判断(思いつき=アイデア、明確な希望=要望)
- 大きなタスク → 親タスクとして記録後、分割の要否を確認
- 重複疑い → 既存チケットとの比較を提示し、統合・新規作成・既存更新を選択
- 実現可能性不明 → 調査タスクとして記録することを提案
- 削除後の参照(Git管理時) → `git log --all --full-history -- path/to/file.md`で履歴参照可能
- 参照リンク切れ → ファイル移動前に参照元を確認し、必要に応じてパス更新

まとめ
-------------------------

このチケット管理システムは柔軟性とシンプルさを重視しています。エージェントとして重要なのは以下の点です。

- ユーザーの意図を正確に理解する
- 適切な種別とテンプレートを選択する
- 不明点は推測せず確認する
- 一貫性のある記録を維持する
- チケット間の関係性を明確にする
- ライフサイクルに応じてファイルを適切に移動・削除する

これらの原則に従うことで、ユーザーにとって有用なチケット管理システムの運用を支援できます。
